[
  {
    "id": "nextjs-static-assets",
    "description": "Next.js static assets",
    "upstream": { "url": "http://id-portal:3000/" },
    "match": {
      "url": "https://id.${DOMAIN}/<_next/.*>",
      "methods": ["GET"]
    },
    "authenticators": [{ "handler": "noop" }],
    "authorizer": { "handler": "allow" },
    "mutators": [{ "handler": "noop" }]
  },
  {
    "id": "root-endpoint",
    "description": "Root endpoint",
    "upstream": { "url": "http://id-portal:3000/" },
    "match": {
      "url": "https://id.${DOMAIN}/",
      "methods": ["GET"]
    },
    "authenticators": [
      {
        "handler": "cookie_session",
        "config": {
          "check_session_url": "http://kratos:4433/sessions/whoami",
          "preserve_path": true,
          "extra_from": "email",
          "subject_from": "identity.id"
        }
      },
      { "handler": "anonymous", "config": { "subject": "guest" } }
    ],
    "authorizer": { "handler": "allow" },
    "mutators": [
      {
        "handler": "header",
        "config": {
          "headers": {
            "X-User-Authenticated": "{{ if .Subject }}true{{ else }}false{{ end }}"
          }
        }
      }
    ]
  },
  {
    "id": "public-endpoints",
    "description": "Public endpoints without session requirement",
    "upstream": { "url": "http://id-portal:3000/" },
    "match": {
      "url": "https://id.${DOMAIN}/<(login|register|api/authenticate|error)>",
      "methods": ["GET", "POST"]
    },
    "authenticators": [
      {
        "handler": "cookie_session",
        "config": {
          "check_session_url": "http://kratos:4433/sessions/whoami",
          "preserve_path": true,
          "extra_from": "email",
          "subject_from": "identity.id"
        }
      },
      { "handler": "anonymous", "config": { "subject": "guest" } }
    ],
    "authorizer": { "handler": "allow" },
    "mutators": [{ "handler": "noop" }]
  },
  {
    "id": "session-required-endpoints",
    "description": "Endpoints requiring valid session",
    "upstream": { "url": "http://id-portal:3000/" },
    "match": {
      "url": "https://id.${DOMAIN}/<(consent|api/consent|api/logout|api/test)>",
      "methods": ["GET", "POST"]
    },
    "authenticators": [
      {
        "handler": "cookie_session",
        "config": {
          "check_session_url": "http://kratos:4433/sessions/whoami",
          "preserve_path": true,
          "extra_from": "email",
          "subject_from": "identity.id"
        }
      }
    ],
    "authorizer": { "handler": "allow" },
    "mutators": [
      {
        "handler": "header",
        "config": {
          "headers": {
            "X-User-Authenticated": "true"
          }
        }
      }
    ]
  }
]
